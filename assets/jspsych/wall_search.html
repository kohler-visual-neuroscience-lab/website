<!DOCTYPE html>
<html>
    <head>
        <title>Blob Similarity</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> 
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-free-sort-ext.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-external-html.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    </head>
    <body>
        <script>
            timeline = [];
              /* init connection with pavlovia.org */
              /*var pavlovia_init = {
                type: "pavlovia",
                command: "init"
              };
              timeline.push(pavlovia_init);*/
            var welcome = {
                type: "html-keyboard-response",
                stimulus: "Welcome to the experiment. Press any key to begin."
            };
            // consent block
            var ask_consent = function(elem) {
            if(document.getElementById('consent_checkbox').checked) {
              return true;
            }
            else {
              alert("Please consent before continuing.");
              return false;
            }
            return false;
            };

            var consent = {
                type: 'external-html',
                url: 'consent.html',
                cont_btn: "start",
                check_fn: ask_consent
            };

            const survey = {
            type: "survey-html-form",
            html: "<div style='text-align: left; vertical-align: top; display: inline-block; float: left; width: 100%'>"+
                "<p><u>Birth Date:</u> <input style='font-size: 18px; line-height: 1.6em;' type='date' id='start' name='dob' min='1960-01-01' max='2020-01-01'></p>"+
                "<p><u>Handedness:</u> </strong><input type='radio' id='left' name='handedness' value='left'>"+
                "<label for='left'>Left-handed</label>"+
                "<input type='radio' id='right' name='handedness' value='right' checked>"+
                "<label for='right'>Right-handed</label>"+
                "<input type='radio' id='ambi' name='handedness' value='ambi'>"+
                "<label for='ambi'>Ambidextrous</label></p>"+
                "<p><u>Sex:</u> <input type='radio' id='female' name='sex' value='female' checked>"+
                "<label for='female'>Female</label>"+
                "<input type='radio' id='male' name='sex' value='male'>"+
                "<label for='male'>Male</label>"+
                "<input type='radio' name='sex' value='other'><label for='other'>Other, please specify: </label>"+ 
                "<input type='text' name='other_sex' id='other_sex' value=''></p>"+
                "<p><u>What race(s) do you identify with? (choose all that apply)</u><br>"+
                "<input type='checkbox' name='race' id='indigenous' value='indigenous' /><label for='indigenous'>Aboriginal (Indigenous) Peoples</label><br>"+
                "<input type='checkbox' name='race' id='black' value='black' /><label for='black'>Black or African-American</label><br>"+
                "<input type='checkbox' name='race' id='asian' value='asian' /><label for='asian'>Asian</label><br>"+
                "<input type='checkbox' name='race' id='white' value='white' /><label for='white'>White</label><br>"+
                "<input type='checkbox' name='race' id='hispanic' value='hispanic' /><label for='hispanic'>Hispanic or Latino/a/x</label><br>"+
                "<input type='checkbox' name='race' id='pacific' value='pacific' /><label for='pacific'>Native Hawaiian or other Pacific Islander</label><br>"+
                "<input type='checkbox' name='race' id='other' value='other' /><label for='other'>Multiracial/Other, please specify: </label>"+
                "<input type='text' name='other_race' id='other_race' value=''>​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​</p></div>",
                preamble: "<strong>Please provide some personal information: </strong>",
                button_label: "continue"
            }

            const instructions = {
            type: "html-keyboard-response",
            stimulus: '<p>On each trial of this experiment, you will be presented with a pattern</p>' +
                '<p>that looks like a wallpaper or a carpet. Patterns will vary in size from trial to trial.</p>' + 
                '<p>Your job is to look for patches where the pattern is <strong>broken</strong> or looks different.</p>' +
                '<p>These patches can occur anywhere in the pattern, but on some trials there will be no broken patch!</p>' +
                '<p>Your goal is to correctly identify both broken and intact patterns.' +
                '<p>Press <strong>D</strong> if pattern is broken, press <strong>L</strong> if pattern is intact</p>' +
                '<p>Please respond as quickly and accurately as possible.</p>' +
                '<p>Press any key to begin.</p>'
            };

            timeline.push(welcome, consent, survey, instructions);

            // define some variables
            const tile_h = 120
            const tile_w = 120
            const letter_keys = ['d', 'l']


            // CODE FOR DEFINING WALLPAPERS
            // general style settings for all images
            const img_dims = 'height=' + Math.floor(tile_h*0.5) + 'px width=' + Math.floor(tile_w*0.5) + 'px '
            const img_style = 'margin:None; vertical-align:top;'

            let p1_html = '<div style="display: inline-block; width: ' + tile_w + 'px; height: ' + tile_h + 'px">'
            for (let i = 1; i <= 4; i++) {
                p1_html += '<img src="img/simple_wallpapers/random_tile' + i + '.png"' + img_dims
                p1_html += 'style="' + img_style + '"></img>'
                if ( i == 2 ) {
                    p1_html += '<br>'
                }
            }
            p1_html += '</div>'

            let pmm_html = '<div style="display: inline-block; width: ' + tile_w + 'px; height: ' + tile_h + 'px">'
            for (let i = 1; i <= 4; i++) {
                pmm_html += '<img src="img/simple_wallpapers/PMM_tile.png"' + img_dims
                let pmm_style = img_style
                if ( i == 2 ) {
                    pmm_style += '; webkit-transform: scale(-1, 1); transform: scale(-1, 1)'
                } else if ( i == 3 ) {
                    pmm_style += '; webkit-transform: scale(1, -1); transform: scale(1, -1)'
                } else if (i == 4 )  {
                    pmm_style += '; webkit-transform: scale(-1, -1); transform: scale(-1, -1);'
                }
                pmm_html += 'style="' + pmm_style + '"></img>'
                if ( i == 2 ) {
                    pmm_html += '<br>'
                }
            }
            pmm_html += '</div>'

            let p2_html = '<div style="display: inline-block; width: ' + tile_w + 'px; height: ' + tile_h + 'px">'
            for (let i = 1; i <= 4; i++) {
                p2_html += '<img src="img/simple_wallpapers/PMM_tile.png"' + img_dims
                let p2_style = img_style
                if ( i == 2 ) {
                    p2_style += '; webkit-transform: scale(-1, 1) rotate(90deg); transform: scale(-1, 1) rotate(90deg)'
                } else if ( i == 3 ) {
                    p2_style += '; webkit-transform: scale(1, -1) rotate(90deg); transform: scale(1, -1) rotate(90deg)'
                } else if (i == 4 )  {
                    p2_style += '; webkit-transform: scale(-1, -1); transform: scale(-1, -1);'
                }
                p2_html += 'style="' + p2_style + '"></img>'
                if ( i == 2 ) {
                    p2_html += '<br>'
                }
            }
            p2_html += '</div>'

            // END OF CODE FOR DEFINING WALLPAPERS

            // NOW DEFINE trials

            const target_trials = 40
            const null_trials = 10

            trial_set = []

            for (const row_len of [3, 4, 5, 6] ) {
                let num_loc = row_len * row_len
                let loc_list = [];
                while (loc_list.length < target_trials ) {
                    let sub_list = []
                    for (let i = 1; i <= num_loc; i++) {
                        sub_list.push(i);
                    }
                    // add shuffled values to list
                    loc_list = loc_list.concat(shuffle(sub_list))
                    console.log(loc_list)
                }
                let target_list = loc_list.slice(0, target_trials);
                while (target_list.length < target_trials + null_trials) {
                    target_list.push(0)
                }
                console.log(target_list)
                target_list = shuffle(target_list) // shuffle again
                for (const target of target_list) {
                    let full_html = '<div id= ' + num_loc + '_' + target + ' '
                        full_html += 'style="background-color: #7f7f7f; ; width: ' + tile_w * row_len + 'px; height: ' + tile_h * row_len + 'px; display: block; margin-left: auto; margin-right: auto">'
                    for (let i = 1; i <= (row_len * row_len); i++) {
                        if ( i == target ) {
                            full_html += p1_html
                        } else {
                            full_html += pmm_html
                        }
                        if ( (i % row_len) == 0 ) {
                            full_html += '<br>'
                        }
                    }
                    full_html += '</div>'
                    let cur_trial = {
                        type: 'html-keyboard-response', //this is the plugin that allows for HTML_STRING as stimuli input
                        stimulus: full_html, //this must be an <img> tag in our case
                        choices: letter_keys,
                        prompt_location: 'below',
                        prompt: '<p align="top">Press <strong>D</strong> if pattern is broken, press <strong>L</strong> if pattern is intact.</p>',
                        post_trial_gap: 1000
                    }
                    trial_set.push(cur_trial) 
                }
            }

            trial_set = shuffle(trial_set) // shuffle the trial set
            timeline = timeline.concat(trial_set) // and add to timeline
            
            
            jsPsych.init({
                timeline:timeline,
                on_finish: function(){
                    const turk_info = jsPsych.turk.turkInfo();
                    const set_c = completion_code("KVNL", "GSQP") 
                    // you can change these two four-letter codes, KVNL stands for Kohler Visual Neuroscience Lab, GSQP are just random letters
                    jsPsych.data.addProperties({
                        workerId: turk_info.workerId,
                        assignmentId: turk_info.assignmentId,
                        hitId: turk_info.hitId,
                        turk_code: set_c
                    });
                end_display(set_c)
                },
                exclusions: {
                  min_width: 800,
                  min_height: 800
                }
                //preload_images: stim_set
            });

            // FUNCTIONS
            function completion_code(prefix, suffix) {
                let code = "";
                for (const i of Array(8).keys()) {
                    let this_num = Math.floor(Math.random() * 10);
                    let this_char = this_num.toString();
                    code = code + this_char;
                }
                code = `${code}-${prefix}-`;

                for (const i of Array(12).keys()) {
                    let this_num = Math.floor(Math.random() * 10);
                    let this_char = this_num.toString();
                    code = code + this_char;
                }
                code = `${code}-${suffix}`;
                return code;
            }

            function end_display(code) {
                const display_element = jsPsych.getDisplayElement();
                display_element.innerHTML = "<p>You have completed the experiment.</p>"+
                                            "<p>We appreciate your participation.</p>"+
                                            "<p>Your secret key code is: <strong>" + code + "</strong></p>"
            }
            // shuffle any input array
            function shuffle(array) {
                // define three variables
                let cur_idx = array.length, tmp_val, rand_idx;

                // While there remain elements to shuffle...
                while (0 !== cur_idx) {
                    // Pick a remaining element...
                    rand_idx = Math.floor(Math.random() * cur_idx);
                    cur_idx -= 1;

                    // And swap it with the current element.
                    tmp_val = array[cur_idx];
                    array[cur_idx] = array[rand_idx];
                    array[rand_idx] = tmp_val;
                }
                return array;
            }
        </script>
    </body> 
</html>